globals [
  ; —————— Core Parameters ——————
  gamma                   ; Knowledge spillover intensity
  delta                   ; AI energy efficiency
  epsilon                 ; Clean transition acceleration coefficient
  disruption-prob         ; External shock probability
  supply                  ; Total supply
  demand                  ; Market demand
  price                   ; Market price
  base-price              ; Base price
  elasticity              ; Price elasticity
  ; —————— Policy Tools ——————
  green-subsidy
  ai-innovation-subsidy
  carbon-tax
  energy-tax
  gov-budget
  budget-capacity
  transition-fund
  avg-ai-level
  avg-ai-gen
  ; —————— Capacity Limits ——————
  max-manufacturers
  max-suppliers
  ; —————— Base Demand ——————
  base-demand
  ; —————— For emergent demand ——————
  system-value-index      ; 
  prev-ai-gen
]

breed [ suppliers supplier ]
breed [ manufacturers manufacturer ]

manufacturers-own [
  competitiveness
  ai-level         ; 0.0 ~ 1.0
  ai-generation    ; G1, G2, G3...
]

suppliers-own [
  competitiveness
]

patches-own [
  countdown        ; Green transition countdown
]

to setup
  clear-all
  file-close-all

  ; Parameter initialization
  set gamma 0.012
  set delta 0.04
  set epsilon 0.001
  set disruption-prob 0.02
  set base-price 1.8
  set elasticity 1.1
  set gov-budget 1000
  set budget-capacity 1000
  set transition-fund 0
  set base-demand 50
  set max-manufacturers 600
  set max-suppliers 3000
  set prev-ai-gen 1.0
  set system-value-index 0          ;; 

  ; Geographic space
  ask patches [
    ifelse random-float 1 < 0.2 [
      set pcolor green
      set countdown 0
    ] [
      set pcolor brown
      set countdown random 60
    ]
  ]

  ; Initial agents
  create-suppliers 100 [
    setxy random-xcor random-ycor
    set shape "circle"
    set color yellow
    set label "S"
    set competitiveness 16
  ]

  create-manufacturers 50 [
    setxy random-xcor random-ycor
    set shape "house"
    set color blue
    set label "G1"
    set competitiveness 30
    set ai-level 0.0
    set ai-generation 1
  ]

  ; CSV header
  file-open "smart-green-manufacturing-data-v9.0-emergent.csv"
  file-print "tick,NumAIFactories,NumSuppliers,GreenZones,AvgAILevel,AvgAIGen,MarketPrice,GovBudget,TransitionFund,Supply,Demand,SVI"
  file-close

  print (word "Setup: AI Factories=" count manufacturers ", Suppliers=" count suppliers)
  reset-ticks
end

to go
  if not any? turtles [ stop ]

  ; —————— Supply ——————
  set supply count suppliers

  ; —————— System Value Index (SVI) → ——————
  let avg-quality       ifelse-value (count manufacturers > 0) [ mean [ai-level] of manufacturers ] [ 0 ]
  let green-reputation  (count patches with [pcolor = green]) / count patches
  let supplier-health   ifelse-value (count suppliers > 0)
                        [ count suppliers with [competitiveness > 5] / count suppliers ] [ 0.1 ]

  set system-value-index (0.40 * avg-quality + 0.40 * green-reputation + 0.20 * supplier-health)


  let svi-boost (1 + system-value-index * 3.2)
  set demand base-demand * (svi-boost ^ 2.0)

  ; —————— Price mechanism (unchanged) ——————
  set price base-price * (demand / supply) ^ elasticity
  set price price * (0.98 + random-float 0.04)
  set price precision (max (list 0.6 (min (list 2.5 price)))) 2

  ; —————— Average AI statistics (still needed elsewhere) ——————
  let ai-values [ai-level] of manufacturers
  let gen-values [ai-generation] of manufacturers
  set avg-ai-level ifelse-value (length ai-values > 0) [ mean ai-values ] [ 0.0 ]
  set avg-ai-gen   ifelse-value (length gen-values > 0) [ mean gen-values ] [ 1.0 ]
  set avg-ai-level precision avg-ai-level 3
  set avg-ai-gen   precision avg-ai-gen 2

  ; —————— Policy sliders ——————
  set green-subsidy green-subsidy-slider
  set ai-innovation-subsidy ai-innovation-slider
  set carbon-tax carbon-tax-slider
  set energy-tax 0.3

  ; —————— Government finance (unchanged) ——————
  let num-low-ai count manufacturers with [ai-level < 0.5]
  let tax-revenue num-low-ai * carbon-tax * 0.8
  let energy-tax-revenue count manufacturers * energy-tax
  set transition-fund transition-fund + tax-revenue * 0.4 + energy-tax-revenue * 0.3

  let green-ratio (count patches with [pcolor = green]) / count patches
  let fund-ratio transition-fund / 100
  let release-rate (0.15 + (1 - green-ratio) * 0.2) * (1 + min (list fund-ratio 2))
  let fund-release min (list (transition-fund * release-rate) (transition-fund * 0.9))
  set transition-fund transition-fund - fund-release
  set gov-budget gov-budget + fund-release
  set gov-budget max (list gov-budget 150)

  let subsidy-scale-factor ifelse-value (gov-budget < 200) [ gov-budget / 200 ] [ 1 ]
  let adjusted-green-subsidy green-subsidy * subsidy-scale-factor
  let adjusted-ai-subsidy ai-innovation-subsidy * subsidy-scale-factor


  ; —————— Manufacturer behavior (100% unchanged) ——————
  ask manufacturers [
    ; Movement
    let target one-of patches in-radius 15 with [pcolor = brown]
    ifelse target != nobody [
      face target
      forward 1
    ] [
      right (random 51 - 25)
      forward 0.5
    ]

    ; Competitiveness gain/loss
    if pcolor = green [ set competitiveness competitiveness + 0.9 ]
    if pcolor = brown [
      set countdown countdown - 5 * ai-level
      if countdown <= 0 [ set pcolor green set countdown 0 ]
    ]

    ; Spillover to suppliers
    let outer-myself self
    ask suppliers in-radius 3 [
      set competitiveness competitiveness + 0.25 * [ai-level] of outer-myself
    ]

    set competitiveness competitiveness - 0.3 + ai-level * delta

    ; Generation upgrade
    if competitiveness > 8 and ai-level > 0.7 [
      let upgrade-cost 15 + ai-generation * 6
      if competitiveness > upgrade-cost [
        set competitiveness competitiveness - upgrade-cost
        set ai-generation ai-generation + 1
        set ai-level ai-level * 0.6 + 0.3
        set color scale-color blue ai-generation 1 6
        set label (word "G" ai-generation)
      ]
    ]

    ; Regular AI upgrade
    if competitiveness > 4 and ai-level < 1.0 [
      let cost 8 + ai-level * 12
      if competitiveness > cost [
        set competitiveness competitiveness - cost
        set ai-level min (list (ai-level + 0.09) 1.0)
        set color scale-color blue ai-level 0 1
        set label precision ai-level 1
      ]
    ]

    ; Knowledge diffusion
    let partners manufacturers in-radius 7 with [ai-level > 0.1]
    if any? partners [
      let partner one-of partners
      let dist distance partner
      if random-float 1 < [ai-level] of partner / (1.5 + dist * 0.5) [
        set ai-level min (list (ai-level + 0.05) 1.0)
        set color scale-color blue ai-level 0 1
        set label precision ai-level 1
      ]
    ]

    ; Policy support
    if pcolor = green and gov-budget >= adjusted-green-subsidy and random-float 1 < 0.3 [
      set competitiveness competitiveness + adjusted-green-subsidy
      set gov-budget gov-budget - adjusted-green-subsidy
    ]
    if ai-level > 0.3 and gov-budget >= adjusted-ai-subsidy and random-float 1 < 0.3 [
      set competitiveness competitiveness + adjusted-ai-subsidy
      set gov-budget gov-budget - adjusted-ai-subsidy
    ]

    ; Backwardness tax
    if ai-level < 0.4 and ticks > 50 [
      set competitiveness competitiveness - carbon-tax * 0.8
    ]

    ; Reproduction
    if competitiveness > 10 and count manufacturers < max-manufacturers and random-float 1 < 0.015 [
      set competitiveness competitiveness / 2
      hatch-manufacturers 1 [
        set ai-level 0.3
        set ai-generation 1
        set color blue
        set label "G1"
        setxy xcor + random-float 2 ycor + random-float 2
        set competitiveness 15
      ]
    ]

    if competitiveness < 0 [ die ]
  ]

  ; —————— Supplier behavior (unchanged) ——————
  ask suppliers [
    right (random 51 - 25)
    forward 0.7
    if pcolor = green [
      set competitiveness competitiveness + 1 + avg-ai-level * gamma
      let base-prob 0.012
      let reproduction-prob base-prob * (price ^ 0.7)
      let market-saturation-factor (1 - (count suppliers / max-suppliers) ^ 0.3)
      let price-effect-factor (price / 1.0) ^ 0.5
      let density-factor (1 - min (list 1 (count suppliers / (max-suppliers * 1.0))))
      let final-prob reproduction-prob * density-factor * market-saturation-factor * price-effect-factor
      if competitiveness > 12 and random-float 1 < final-prob and (count suppliers / max list 1 count manufacturers) < 10 [
        set competitiveness competitiveness / 2
        hatch 1 [ forward 1 ]
      ]
    ]
    if pcolor = brown [ set competitiveness competitiveness - 0.65 ]
    if competitiveness < 0 [ die ]
  ]

  ; —————— Green transition acceleration ——————
  ask patches with [pcolor = brown] [
    set countdown countdown - 0.1 + avg-ai-level * epsilon * 0.5
    if countdown <= 0 [ set pcolor green set countdown 0 ]
  ]

  ; —————— External shocks ——————
  if random-float 1 < disruption-prob [
    ask n-of (0.04 * count patches) patches [
      set pcolor brown
      set countdown countdown + random 30
    ]
    ask manufacturers [ set competitiveness competitiveness * 0.75 ]
  ]

  ; —————— Data recording (added SVI column) ——————
  if ticks mod 20 = 0 [
    print (word "T=" ticks
      " M=" count manufacturers
      " S=" count suppliers
      " Green=" count patches with [pcolor = green]
      " AI-L=" precision avg-ai-level 2
      " Gen=" precision avg-ai-gen 1
      " Price=" precision price 2
      " Budget=" precision gov-budget 0
      " Fund=" precision transition-fund 0
      " SVI=" precision system-value-index 3)

    file-open "smart-green-manufacturing-data-v9.0-emergent.csv"
    file-print (word ticks "," count manufacturers "," count suppliers ","
                count patches with [pcolor = green] "," precision avg-ai-level 2 ","
                precision avg-ai-gen 2 "," precision price 2 ","
                precision gov-budget 0 "," precision transition-fund 0 ","
                supply "," demand "," precision system-value-index 3)
    file-close
  ]

  tick
end
